<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HealthGYM | Challenges</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; }
        .difficulty-Beginner { background-color: #198754; color: white; }
        .difficulty-Intermediate { background-color: #fd7e14; color: white; }
        .difficulty-Advanced { background-color: #dc3545; color: white; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-success mb-4">
    <div class="container">
        <a class="navbar-brand" href="dashboard.html"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
        <span class="navbar-text text-light fw-bold"><i class="fas fa-trophy"></i> Daily Challenges</span>
    </div>
</nav>

<div class="container">
    
    <div id="trainerControls" class="card shadow-sm mb-4 border-success" style="display: none;">
        <div class="card-header bg-white text-success fw-bold">
            <i class="fas fa-plus-circle"></i> Trainer Tool: Post New Challenge
        </div>
        <div class="card-body">
            <form id="createForm" class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="cTitle" class="form-control" placeholder="Challenge Title (e.g. 100 Pushups)" required>
                </div>
                <div class="col-md-3">
                    <select id="cDiff" class="form-select">
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" id="cPoints" class="form-control" placeholder="Points" value="50">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-success w-100">Post Challenge</button>
                </div>
                <div class="col-12">
                    <input type="text" id="cDesc" class="form-control" placeholder="Short description..." required>
                </div>
            </form>
        </div>
    </div>

    <h5 class="mb-3 text-muted">Active Challenges</h5>
    <div class="row" id="challengesList">
        <div class="text-center py-5"><div class="spinner-border text-success"></div></div>
    </div>

</div>

<script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role'); 

    if(!token) window.location.href = 'login.html';

    // 1. Setup UI based on Role
    if (role === 'trainer' || role === 'admin') {
        document.getElementById('trainerControls').style.display = 'block';
        if(role === 'admin') {
            document.querySelector('.card-header').innerHTML = '<i class="fas fa-shield-alt"></i> Admin Tool: Manage Challenges';
            document.querySelector('.card-header').classList.replace('text-success', 'text-danger');
        }
    }

    // 2. Load Data
    async function loadChallenges() {
        try {
            const res = await fetch('/api/challenges/', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            const container = document.getElementById('challengesList');
            container.innerHTML = '';

            if(data.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No active challenges found.</p>';
                return;
            }

            data.forEach(c => {
                // LOGIC: Determine how the card looks
                let actionArea = '';
                let badge = `<span class="badge difficulty-${c.difficulty}">${c.difficulty}</span>`;

                if (!c.is_active) {
                    // It's PENDING
                    if (role === 'admin') {
                        // Admin sees Approve Button
                        actionArea = `
                            <div class="alert alert-warning py-1 mb-2 small"><i class="fas fa-clock"></i> Pending Approval</div>
                            <button onclick="approveChallenge(${c.id})" class="btn btn-sm btn-success w-100 mb-1">Approve</button>
                            <button onclick="deleteChallenge(${c.id})" class="btn btn-sm btn-outline-danger w-100">Reject/Delete</button>
                        `;
                    } else {
                        // Trainer/User just sees status
                        actionArea = `<div class="alert alert-secondary py-1 small">Pending Admin Approval</div>`;
                    }
                } else {
                    // It's ACTIVE
                    actionArea = `
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <span class="text-warning fw-bold"><i class="fas fa-star"></i> ${c.points} pts</span>
                            <button class="btn btn-outline-success btn-sm">Join Now</button>
                        </div>
                        ${role === 'admin' ? `<button onclick="deleteChallenge(${c.id})" class="btn btn-sm btn-link text-danger mt-2">Delete</button>` : ''}
                    `;
                }

                container.innerHTML += `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm border-0 ${!c.is_active ? 'opacity-75' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title fw-bold">${c.title}</h5>
                                ${badge}
                            </div>
                            <p class="card-text text-muted">${c.description}</p>
                            ${actionArea}
                        </div>
                    </div>
                </div>`;
            });

        } catch(e) { console.error(e); }
    }

    // 3. Create Challenge
    document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            title: document.getElementById('cTitle').value,
            description: document.getElementById('cDesc').value,
            difficulty: document.getElementById('cDiff').value,
            points: parseInt(document.getElementById('cPoints').value)
        };

        const res = await fetch('/api/challenges/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            const result = await res.json();
            if(result.is_active) {
                alert("Challenge Published Instantly (Admin Override)");
            } else {
                alert("Challenge Submitted! Waiting for Admin Approval.");
            }
            document.getElementById('createForm').reset();
            loadChallenges(); 
        } else {
            alert("Error posting challenge");
        }
    });

    // 4. Admin Actions
    async function approveChallenge(id) {
        if(!confirm("Approve this challenge for all members?")) return;
        await fetch(`/api/challenges/${id}/approve`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadChallenges();
    }

    async function deleteChallenge(id) {
        if(!confirm("Permanently delete this challenge?")) return;
        await fetch(`/api/challenges/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadChallenges();
    }

    loadChallenges();
</script>
<script src="/js/auth.js"></script>
<script>
    // Require authentication to view challenges
    if (!requireAuth()) {
        // requireAuth will redirect to /login.html
    }
</script>
</body>
</html>
