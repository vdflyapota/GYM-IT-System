<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Diagnostic Tool - GYM IT System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .result-box {
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .result-box.success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        .result-box.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        .result-box.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .code-block {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1><i class="fas fa-stethoscope"></i> JWT Diagnostic Tool</h1>
                <p class="text-muted">This page helps diagnose JWT authentication issues</p>
                <hr>
                
                <button id="runDiagnostics" class="btn btn-primary btn-lg mb-4">
                    <i class="fas fa-play"></i> Run JWT Diagnostics
                </button>
                
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/tournaments';
        
        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultBox = document.createElement('div');
            resultBox.className = `result-box ${type}`;
            resultBox.innerHTML = `<h5>${title}</h5>${content}`;
            resultsDiv.appendChild(resultBox);
        }

        function addCodeBlock(code) {
            return `<div class="code-block">${escapeHtml(code)}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function decodeJWT(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) {
                    return { error: 'Invalid JWT format - should have 3 parts separated by dots' };
                }
                
                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));
                
                return { header, payload };
            } catch (e) {
                return { error: `Failed to decode JWT: ${e.message}` };
            }
        }

        async function runDiagnostics() {
            document.getElementById('results').innerHTML = '';
            
            // Test 1: Check if token exists
            const token = localStorage.getItem('token');
            if (!token) {
                addResult(
                    '‚ùå Test 1: Token Existence',
                    '<p>No JWT token found in localStorage.</p><p><strong>Action:</strong> Please log in first.</p>',
                    'error'
                );
                return;
            } else {
                addResult(
                    '‚úÖ Test 1: Token Existence',
                    '<p>JWT token found in localStorage</p>',
                    'success'
                );
            }

            // Test 2: Decode JWT
            const decoded = decodeJWT(token);
            if (decoded.error) {
                addResult(
                    '‚ùå Test 2: JWT Structure',
                    `<p>${decoded.error}</p>${addCodeBlock(token.substring(0, 100) + '...')}`,
                    'error'
                );
                return;
            } else {
                const headerInfo = `Header:\n${JSON.stringify(decoded.header, null, 2)}`;
                const payloadInfo = `Payload:\n${JSON.stringify(decoded.payload, null, 2)}`;
                
                let content = '<p>JWT successfully decoded</p>';
                content += addCodeBlock(headerInfo);
                content += addCodeBlock(payloadInfo);
                
                // Check algorithm
                if (decoded.header.alg) {
                    if (decoded.header.alg === 'HS256') {
                        content += '<p class="text-success mt-2">‚úÖ Algorithm: HS256 (correct)</p>';
                    } else {
                        content += `<p class="text-warning mt-2">‚ö†Ô∏è Algorithm: ${decoded.header.alg} (expected HS256)</p>`;
                    }
                }
                
                // Check expiration
                if (decoded.payload.exp) {
                    const expDate = new Date(decoded.payload.exp * 1000);
                    const now = new Date();
                    if (expDate > now) {
                        content += `<p class="text-success">‚úÖ Token expires: ${expDate.toLocaleString()}</p>`;
                    } else {
                        content += `<p class="text-danger">‚ùå Token expired: ${expDate.toLocaleString()}</p>`;
                    }
                }
                
                addResult('‚úÖ Test 2: JWT Structure', content, 'success');
            }

            // Test 3: Test healthz endpoint
            try {
                const healthResponse = await fetch('/healthz');
                const healthData = await healthResponse.json();
                addResult(
                    '‚úÖ Test 3: Gateway Health Check',
                    `<p>Status: ${healthResponse.status}</p>${addCodeBlock(JSON.stringify(healthData, null, 2))}`,
                    'success'
                );
            } catch (error) {
                addResult(
                    '‚ùå Test 3: Gateway Health Check',
                    `<p>Failed to connect to gateway</p><p>${error.message}</p>`,
                    'error'
                );
            }

            // Test 4: Test leaderboard endpoint
            try {
                const response = await fetch(`${API_BASE}/leaderboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let content = `<p><strong>HTTP Status:</strong> ${response.status}</p>`;
                content += `<p><strong>Status Text:</strong> ${response.statusText}</p>`;
                content += `<p><strong>OK:</strong> ${response.ok}</p>`;

                let responseData;
                try {
                    responseData = await response.json();
                    content += `<p><strong>Response:</strong></p>${addCodeBlock(JSON.stringify(responseData, null, 2))}`;
                } catch (e) {
                    content += `<p><strong>Response:</strong> (not JSON)</p>`;
                }

                if (response.ok) {
                    addResult('‚úÖ Test 4: Leaderboard Endpoint', content, 'success');
                } else {
                    if (response.status === 401) {
                        content += '<p class="text-danger mt-2"><strong>Issue:</strong> Unauthorized - Token not valid</p>';
                    } else if (response.status === 422) {
                        content += '<p class="text-danger mt-2"><strong>Issue:</strong> Signature verification failed</p>';
                        content += '<p><strong>Cause:</strong> JWT_SECRET_KEY or JWT_ALGORITHM mismatch between services</p>';
                        content += '<p><strong>Fix:</strong> Ensure both auth-service and tournament-service have matching JWT configuration</p>';
                    }
                    addResult('‚ùå Test 4: Leaderboard Endpoint', content, 'error');
                }
            } catch (error) {
                addResult(
                    '‚ùå Test 4: Leaderboard Endpoint',
                    `<p>Request failed</p><p>${error.message}</p>`,
                    'error'
                );
            }

            // Test 5: Summary
            addResult(
                'üìã Diagnostic Summary',
                `<p>Diagnostic complete. Review results above.</p>
                <p>If you see "Signature verification failed", the services need to be restarted with matching JWT configuration.</p>
                <p>If you see "Unauthorized", the token might be invalid or expired.</p>`,
                'info'
            );
        }

        document.getElementById('runDiagnostics').addEventListener('click', runDiagnostics);
    </script>
</body>
</html>
