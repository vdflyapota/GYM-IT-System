services:
  # API Gateway - Entry point for all requests
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: gymit-api-gateway
    environment:
      - SECRET_KEY=${SECRET_KEY:-gateway-secret}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-shared-jwt-secret}
      - AUTH_SERVICE_URL=http://auth-service:8001
      - USER_SERVICE_URL=http://user-service:8002
      - TOURNAMENT_SERVICE_URL=http://tournament-service:8003
      - NOTIFICATION_SERVICE_URL=http://notification-service:8004
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - ENV=${ENV:-development}
    ports:
      - "8000:8000"
    depends_on:
      - auth-service
      - user-service
      - tournament-service
      - notification-service
    volumes:
      - ./services/api-gateway:/app:delegated
      - ./static:/app/static:ro
    restart: unless-stopped
    networks:
      - microservices-net

  # Auth Service - Handles authentication and JWT generation
  auth-service:
    build:
      context: ./services/auth-service
      dockerfile: Dockerfile
    container_name: gymit-auth-service
    environment:
      - SECRET_KEY=${SECRET_KEY:-auth-secret}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-shared-jwt-secret}
      - DATABASE_URL=postgresql+psycopg2://authuser:authpass@auth-db:5432/authdb
      - REDIS_URL=redis://redis:6379/0
      - USER_SERVICE_URL=http://user-service:8002
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@gym.it}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - ENV=${ENV:-development}
    ports:
      - "8001:8001"
    depends_on:
      auth-db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ./services/auth-service:/app:delegated
    restart: unless-stopped
    networks:
      - microservices-net

  # User Service - Manages user profiles and permissions
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: gymit-user-service
    environment:
      - SECRET_KEY=${SECRET_KEY:-user-secret}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-shared-jwt-secret}
      - DATABASE_URL=postgresql+psycopg2://useruser:userpass@user-db:5432/userdb
      - REDIS_URL=redis://redis:6379/0
      - AUTH_SERVICE_URL=http://auth-service:8001
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - ENV=${ENV:-development}
    ports:
      - "8002:8002"
    depends_on:
      user-db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ./services/user-service:/app:delegated
    restart: unless-stopped
    networks:
      - microservices-net

  # Tournament Service - Manages tournaments, brackets, and matches
  tournament-service:
    build:
      context: ./services/tournament-service
      dockerfile: Dockerfile
    container_name: gymit-tournament-service
    environment:
      - SECRET_KEY=${SECRET_KEY:-tournament-secret}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-shared-jwt-secret}
      - DATABASE_URL=postgresql+psycopg2://tournamentuser:tournamentpass@tournament-db:5432/tournamentdb
      - REDIS_URL=redis://redis:6379/0
      - USER_SERVICE_URL=http://user-service:8002
      - NOTIFICATION_SERVICE_URL=http://notification-service:8004
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - ENV=${ENV:-development}
    ports:
      - "8003:8003"
    depends_on:
      tournament-db:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - ./services/tournament-service:/app:delegated
    restart: unless-stopped
    networks:
      - microservices-net

  # Notification Service - WebSocket and real-time notifications
  notification-service:
    build:
      context: ./services/notification-service
      dockerfile: Dockerfile
    container_name: gymit-notification-service
    environment:
      - SECRET_KEY=${SECRET_KEY:-notification-secret}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-shared-jwt-secret}
      - REDIS_URL=redis://redis:6379/0
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - ENV=${ENV:-development}
    ports:
      - "8004:8004"
    depends_on:
      redis:
        condition: service_started
    volumes:
      - ./services/notification-service:/app:delegated
    restart: unless-stopped
    networks:
      - microservices-net

  # Database for Auth Service
  auth-db:
    image: postgres:16
    container_name: gymit-auth-db
    environment:
      POSTGRES_USER: authuser
      POSTGRES_PASSWORD: authpass
      POSTGRES_DB: authdb
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U authuser -d authdb"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - auth-db-data:/var/lib/postgresql/data
    networks:
      - microservices-net

  # Database for User Service
  user-db:
    image: postgres:16
    container_name: gymit-user-db
    environment:
      POSTGRES_USER: useruser
      POSTGRES_PASSWORD: userpass
      POSTGRES_DB: userdb
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U useruser -d userdb"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - user-db-data:/var/lib/postgresql/data
    networks:
      - microservices-net

  # Database for Tournament Service
  tournament-db:
    image: postgres:16
    container_name: gymit-tournament-db
    environment:
      POSTGRES_USER: tournamentuser
      POSTGRES_PASSWORD: tournamentpass
      POSTGRES_DB: tournamentdb
    ports:
      - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tournamentuser -d tournamentdb"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - tournament-db-data:/var/lib/postgresql/data
    networks:
      - microservices-net

  # Shared Redis for caching and pub/sub
  redis:
    image: redis:7
    container_name: gymit-redis
    ports:
      - "6379:6379"
    networks:
      - microservices-net

networks:
  microservices-net:
    driver: bridge

volumes:
  auth-db-data:
  user-db-data:
  tournament-db-data:
